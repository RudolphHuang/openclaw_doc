# å¿«é€Ÿå¼€å§‹

æ¬¢è¿ä½¿ç”¨ LobeChat API æ–‡æ¡£ï¼æœ¬æŒ‡å—å¸®åŠ©å‰ç«¯å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹ã€‚

## ğŸ“š æ–‡æ¡£ç»“æ„

```
api/
â”œâ”€â”€ README.md              # ä¸»ç›®å½•ï¼ˆä»è¿™é‡Œå¼€å§‹ï¼‰
â”œâ”€â”€ SUMMARY.md             # æ–‡æ¡£å®ŒæˆçŠ¶æ€æ€»ç»“
â”œâ”€â”€ å¿«é€Ÿå¼€å§‹.md            # æœ¬æ–‡ä»¶
â”œâ”€â”€ RESTful/               # RESTful WebAPI æ¥å£
â”‚   â”œâ”€â”€ chat.md           # âœ… AI èŠå¤©ï¼ˆè¯¦ç»†ï¼‰
â”‚   â”œâ”€â”€ tts-openai.md     # ğŸ“ TTSï¼ˆç®€è¦ï¼‰
â”‚   â””â”€â”€ ...
â””â”€â”€ tRPC/                  # tRPC æ¥å£
    â”œâ”€â”€ lambda/            # ä¸»ä¸šåŠ¡æ¥å£
    â”‚   â”œâ”€â”€ user.md       # âœ… ç”¨æˆ·ç®¡ç†ï¼ˆè¯¦ç»†ï¼‰
    â”‚   â”œâ”€â”€ session.md    # âœ… ä¼šè¯ç®¡ç†ï¼ˆè¯¦ç»†ï¼‰
    â”‚   â”œâ”€â”€ message.md    # âœ… æ¶ˆæ¯ç®¡ç†ï¼ˆè¯¦ç»†ï¼‰
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ async/             # å¼‚æ­¥ä»»åŠ¡æ¥å£
    â”œâ”€â”€ tools/             # å·¥å…·æ¥å£
    â””â”€â”€ mobile/            # ç§»åŠ¨ç«¯æ¥å£
```

**å›¾ä¾‹**:
- âœ… = è¯¦ç»†æ–‡æ¡£ï¼ˆåŒ…å«å®Œæ•´è¯´æ˜ã€ç¤ºä¾‹ã€æœ€ä½³å®è·µï¼‰
- ğŸ“ = ç®€è¦æ–‡æ¡£ï¼ˆåŸºæœ¬è¯´æ˜å’Œç¤ºä¾‹ï¼‰
- âš ï¸ = å¾…è¡¥å……ï¼ˆå¯å‚è€ƒæºç ï¼‰

---

## ğŸš€ 5 åˆ†é’Ÿå¿«é€Ÿå…¥é—¨

### 1. ç†è§£ API æ¶æ„

LobeChat æä¾›ä¸¤ç§ APIï¼š

```typescript
// RESTful WebAPI - ç”¨äºç‰¹æ®Šåœºæ™¯ï¼ˆæµå¼å“åº”ã€æ–‡ä»¶æœåŠ¡ç­‰ï¼‰
POST /webapi/chat/openai
POST /webapi/tts/openai

// tRPC - ç±»å‹å®‰å…¨çš„ä¸»è¦ä¸šåŠ¡æ¥å£
trpc.session.createSession.mutate(...)
trpc.message.getMessages.query(...)
```

### 2. è®¤è¯

å¤§å¤šæ•°æ¥å£éœ€è¦ JWT Tokenï¼š

```typescript
// è·å– Tokenï¼ˆå‡è®¾å·²ç™»å½•ï¼‰
const token = getAuthToken();

// RESTful API
fetch('/webapi/chat/openai', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});

// tRPCï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰
const sessions = await trpc.session.getSessions.query();
```

### 3. æ ¸å¿ƒåŠŸèƒ½ç¤ºä¾‹

#### åˆ›å»ºä¼šè¯å¹¶å‘é€æ¶ˆæ¯

```typescript
// 1. åˆ›å»ºä¼šè¯
const sessionId = await trpc.session.createSession.mutate({
  type: 'agent',
  session: {
    title: 'æˆ‘çš„ AI åŠ©æ‰‹'
  },
  config: {
    systemRole: 'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹',
    model: 'gpt-4',
    provider: 'openai'
  }
});

// 2. åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
const messageId = await trpc.message.createMessage.mutate({
  role: 'user',
  content: 'ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±',
  sessionId: sessionId
});

// 3. è°ƒç”¨ AI ç”Ÿæˆå›å¤ï¼ˆæµå¼ï¼‰
const response = await fetch(`/webapi/chat/openai`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    messages: [
      { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹' },
      { role: 'user', content: 'ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±' }
    ],
    model: 'gpt-4',
    stream: true
  })
});

// 4. å¤„ç†æµå¼å“åº”
const reader = response.body.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  
  const chunk = decoder.decode(value);
  // å¤„ç†æ¯ä¸ªæ•°æ®å—...
}

// 5. ä¿å­˜ AI å›å¤
await trpc.message.createMessage.mutate({
  role: 'assistant',
  content: aiResponse,
  sessionId: sessionId,
  parentId: messageId
});
```

#### æ–‡ä»¶ä¸Šä¼ å’Œ RAG

```typescript
// 1. åˆ›å»ºçŸ¥è¯†åº“
const kbId = await trpc.knowledgeBase.createKnowledgeBase.mutate({
  name: 'æŠ€æœ¯æ–‡æ¡£',
  description: 'API æ–‡æ¡£å’Œæ•™ç¨‹'
});

// 2. ä¸Šä¼ æ–‡ä»¶
const file = document.getElementById('fileInput').files[0];

// 2.1 åˆ›å»ºä¸Šä¼ ä»»åŠ¡
const { uploadUrl, fileKey } = await trpc.upload.createUploadTask.mutate({
  filename: file.name,
  fileType: file.type,
  size: file.size
});

// 2.2 ä¸Šä¼ åˆ° S3
await fetch(uploadUrl, {
  method: 'PUT',
  body: file
});

// 2.3 åˆ›å»ºæ–‡ä»¶è®°å½•
const fileId = await trpc.file.createFile.mutate({
  name: file.name,
  fileType: file.type,
  size: file.size,
  url: fileKey,
  knowledgeBaseId: kbId
});

// 3. ç­‰å¾…æ–‡ä»¶å¤„ç†ï¼ˆåˆ†å—å’ŒåµŒå…¥ï¼‰
const checkStatus = async () => {
  const fileInfo = await trpc.file.getFileItemById.query({ id: fileId });
  
  if (fileInfo.finishEmbedding) {
    console.log('âœ… æ–‡ä»¶å¤„ç†å®Œæˆ');
    return true;
  }
  
  setTimeout(checkStatus, 2000);
};

await checkStatus();

// 4. ç»‘å®šåˆ° Agent
const config = await trpc.agent.getAgentConfig.query({ sessionId });
await trpc.agent.createAgentKnowledgeBase.mutate({
  agentId: config.id,
  knowledgeBaseId: kbId
});

// 5. ç°åœ¨å¯¹è¯ä¼šè‡ªåŠ¨ä½¿ç”¨çŸ¥è¯†åº“ï¼
```

---

## ğŸ“– å¸¸ç”¨æ¥å£é€ŸæŸ¥

### ç”¨æˆ·ç®¡ç†

```typescript
// è·å–ç”¨æˆ·çŠ¶æ€
trpc.user.getUserState.query()

// æ›´æ–°ç”¨æˆ·è®¾ç½®
trpc.user.updateSettings.mutate({ ... })

// æ›´æ–°å¤´åƒ
trpc.user.updateAvatar.mutate(avatarUrl)
```

### ä¼šè¯ç®¡ç†

```typescript
// è·å–æ‰€æœ‰ä¼šè¯
trpc.session.getGroupedSessions.query()

// åˆ›å»ºä¼šè¯
trpc.session.createSession.mutate({ type, session, config })

// æ›´æ–°ä¼šè¯
trpc.session.updateSession.mutate({ id, value })

// åˆ é™¤ä¼šè¯
trpc.session.removeSession.mutate({ id })

// æœç´¢ä¼šè¯
trpc.session.searchSessions.query({ keywords })
```

### æ¶ˆæ¯ç®¡ç†

```typescript
// è·å–æ¶ˆæ¯
trpc.message.getMessages.query({ sessionId, current, pageSize })

// åˆ›å»ºæ¶ˆæ¯
trpc.message.createMessage.mutate({ role, content, sessionId })

// æ›´æ–°æ¶ˆæ¯
trpc.message.update.mutate({ id, value })

// åˆ é™¤æ¶ˆæ¯
trpc.message.removeMessage.mutate({ id })

// æœç´¢æ¶ˆæ¯
trpc.message.searchMessages.query({ keywords })
```

### æ–‡ä»¶ä¸çŸ¥è¯†åº“

```typescript
// æ–‡ä»¶ç®¡ç†
trpc.file.getFiles.query({ knowledgeBaseId })
trpc.file.createFile.mutate({ ... })
trpc.file.removeFile.mutate({ id })

// çŸ¥è¯†åº“ç®¡ç†
trpc.knowledgeBase.getKnowledgeBases.query()
trpc.knowledgeBase.createKnowledgeBase.mutate({ name, description })
trpc.knowledgeBase.addFilesToKnowledgeBase.mutate({ knowledgeBaseId, ids })

// Agent çŸ¥è¯†åº“ç»‘å®š
trpc.agent.createAgentKnowledgeBase.mutate({ agentId, knowledgeBaseId })
```

### AI èŠå¤©

```typescript
// æµå¼å¯¹è¯
POST /webapi/chat/:provider
{
  messages: [...],
  model: 'gpt-4',
  stream: true
}

// TTSï¼ˆæ–‡æœ¬è½¬è¯­éŸ³ï¼‰
POST /webapi/tts/openai
{
  input: 'ä½ å¥½',
  voice: 'nova'
}

// STTï¼ˆè¯­éŸ³è½¬æ–‡å­—ï¼‰
POST /webapi/stt/openai
FormData: { file: audioFile }
```

---

## ğŸ¯ æ¨èé˜…è¯»è·¯å¾„

### æ–°æ‰‹å¼€å‘è€…

1. âœ… [session.md](tRPC/lambda/session.md) - ç†è§£ä¼šè¯ç®¡ç†
2. âœ… [message.md](tRPC/lambda/message.md) - ç†è§£æ¶ˆæ¯ç®¡ç†
3. âœ… [RESTful/chat.md](RESTful/chat.md) - ç†è§£ AI å¯¹è¯

### è¿›é˜¶å¼€å‘è€…

4. âœ… [agent.md](tRPC/lambda/agent.md) - Agent é…ç½®
5. âœ… [knowledgeBase.md](tRPC/lambda/knowledgeBase.md) - çŸ¥è¯†åº“ç®¡ç†
6. âœ… [file.md](tRPC/lambda/file.md) - æ–‡ä»¶ç®¡ç†
7. âœ… [async/file.md](tRPC/async/file.md) - å¼‚æ­¥æ–‡ä»¶å¤„ç†

### é«˜çº§å¼€å‘è€…

8. âœ… [user.md](tRPC/lambda/user.md) - ç”¨æˆ·ç®¡ç†ï¼ˆåŒ…å«ç§¯åˆ†ç³»ç»Ÿï¼‰
9. âœ… [tools/search.md](tRPC/tools/search.md) - æœç´¢å·¥å…·é›†æˆ
10. ğŸ“ [generation.md](tRPC/lambda/generation.md) - å›¾åƒç”Ÿæˆ

---

## ğŸ’¡ å¼€å‘æŠ€å·§

### 1. ç±»å‹å®‰å…¨

```typescript
// tRPC æä¾›å®Œæ•´çš„ç±»å‹æ¨å¯¼
const sessions = await trpc.session.getSessions.query();
//    ^ ç±»å‹è‡ªåŠ¨æ¨å¯¼ä¸º Session[]

// TypeScript ä¼šæ£€æŸ¥å‚æ•°ç±»å‹
await trpc.message.createMessage.mutate({
  role: 'user',        // âœ… ç±»å‹æ£€æŸ¥
  content: 'hello',
  sessionId: '...'
});
```

### 2. é”™è¯¯å¤„ç†

```typescript
try {
  await trpc.session.createSession.mutate({ ... });
} catch (error) {
  if (error.code === 'UNAUTHORIZED') {
    // æœªæˆæƒ
  } else if (error.code === 'BAD_REQUEST') {
    // å‚æ•°é”™è¯¯
  }
}
```

### 3. å¹¶å‘è¯·æ±‚

```typescript
// å¹¶è¡Œè·å–å¤šä¸ªèµ„æº
const [sessions, messages, topics] = await Promise.all([
  trpc.session.getSessions.query(),
  trpc.message.getMessages.query({ sessionId }),
  trpc.topic.getTopics.query({ containerId: sessionId })
]);
```

### 4. æµå¼å“åº”å¤„ç†

```typescript
// ä½¿ç”¨ async generator å¤„ç†æµ
async function* streamChat(messages) {
  const response = await fetch('/webapi/chat/openai', {
    method: 'POST',
    body: JSON.stringify({ messages, stream: true })
  });
  
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    const chunk = decoder.decode(value);
    const lines = chunk.split('\n');
    
    for (const line of lines) {
      if (line.startsWith('data: ')) {
        const data = line.slice(6);
        if (data === '[DONE]') return;
        
        try {
          const json = JSON.parse(data);
          yield json.choices[0]?.delta?.content || '';
        } catch (e) {}
      }
    }
  }
}

// ä½¿ç”¨
for await (const chunk of streamChat(messages)) {
  console.log(chunk);
}
```

---

## ğŸ”— ç›¸å…³èµ„æº

- [å®Œæ•´ API ç›®å½•](README.md)
- [æ–‡æ¡£å®ŒæˆçŠ¶æ€](SUMMARY.md)
- [é¡¹ç›®æºç ](../../src/)

---

## â“ å¸¸è§é—®é¢˜

### Q: tRPC å’Œ RESTful API æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

A: 
- **tRPC**: ç±»å‹å®‰å…¨ï¼Œé€‚åˆä¸šåŠ¡é€»è¾‘ï¼ˆCRUD æ“ä½œï¼‰
- **RESTful**: ç”¨äºç‰¹æ®Šåœºæ™¯ï¼ˆæµå¼å“åº”ã€æ–‡ä»¶ä¸Šä¼ ç­‰ï¼‰

### Q: å¦‚ä½•è°ƒè¯• APIï¼Ÿ

A:
1. æµè§ˆå™¨ DevTools Network é¢æ¿
2. æŸ¥çœ‹ tRPC è¯·æ±‚ï¼šè¿‡æ»¤ `/trpc/`
3. æŸ¥çœ‹ RESTful è¯·æ±‚ï¼šè¿‡æ»¤ `/webapi/`

### Q: API é€Ÿç‡é™åˆ¶æ˜¯å¤šå°‘ï¼Ÿ

A: å–å†³äºå…·ä½“æ¥å£å’Œç”¨æˆ·é…ç½®ï¼Œé€šå¸¸æ— ç‰¹æ®Šé™åˆ¶ã€‚æµå¼å¯¹è¯æœ‰ 300 ç§’è¶…æ—¶ã€‚

### Q: å¦‚ä½•å¤„ç†è®¤è¯å¤±è´¥ï¼Ÿ

A:
```typescript
if (error.code === 'UNAUTHORIZED') {
  // é‡å®šå‘åˆ°ç™»å½•é¡µ
  router.push('/login');
}
```

---

ç¥å¼€å‘æ„‰å¿«ï¼ğŸ‰
